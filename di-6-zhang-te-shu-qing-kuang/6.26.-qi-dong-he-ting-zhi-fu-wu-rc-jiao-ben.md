# 6.26.启动和停止服务 (rc 脚本)

**rc.d** 脚本被用于在系统启动时启动服务，同时给予管理员一种标准的方式来停止，启动和重启服务。 port 集成到系统 **rc.d** 框架中。其使用细节可以在 [Handbook 中 rc.d 章节](https://docs.freebsd.org/en/books/handbook/#configtuning-rcd)中找到。可用命令的详细解释在 [rc(8)](https://man.freebsd.org/cgi/man.cgi?query=rc&sektion=8&format=html) 和 [rc.subr(8)](https://man.freebsd.org/cgi/man.cgi?query=rc.subr&sektion=8&format=html) 中提供。最后，[这里](https://docs.freebsd.org/en/articles/rc-scripting/)有一篇关于 **rc.d** 脚本实际方面的文章。

假设有一个虚拟 port 名叫 *doorman* ，需要启动一个 *doorman* 守护进程。在 **Makefile** 文件中添加：

`USE_RC_SUBR=    doormand`

可以列出多个脚本并进行安装。这些脚本必须位于 **files** 子目录中并且必须在文件名后添加 `.in` 后缀。标准 `SUB_LIST` 文件扩展名会与这文件发生冲突。强烈鼓励使用 `%%PREFIX%%` 和 `%%LOCALBASE%%` 文件扩展名。更多关于 `SUB_LIST` 的信息可以在[相关章节](https://docs.freebsd.org/en/books/porters-handbook/book/#using-sub-files)找到。

一个简单的 **rc.d** 脚本来启动 doormand 守护进程的例子：

```
#!/bin/sh

# PROVIDE: doormand
# REQUIRE: LOGIN
# KEYWORD: shutdown
#
# Add these lines to /etc/rc.conf.local or /etc/rc.conf
# to enable this service:
#
# doormand_enable (bool):	Set to NO by default.
#				Set it to YES to enable doormand.
# doormand_config (path):	Set to %%PREFIX%%/etc/doormand/doormand.cf
#				by default.

. /etc/rc.subr

name=doormand
rcvar=doormand_enable

load_rc_config $name

: ${doormand_enable:="NO"}
: ${doormand_config="%%PREFIX%%/etc/doormand/doormand.cf"}

command=%%PREFIX%%/sbin/${name}
pidfile=/var/run/${name}.pid

command_args="-p $pidfile -f $doormand_config"

run_rc_command "$1"
```

除非有非常好的理由需要更早地启动服务，或者以特定用户（不是 root ）运行，否则所有 port 脚本都必须使用以下语句：

`REQUIRE: LOGIN`

如果启动脚本启动了必须关闭的守护进程，则以下语句将在系统关闭时触发服务的停止：

`KEYWORD: shutdown`

如果脚本不启动持久服务，则不需要这样做。

对于可选配置元素，这里更推荐使用“=”风格的默认变量赋值，而不是“:=”风格，因为前者仅在变量未设置时设置默认值，而后者则在变量未设置或为空时设置默认值。用户可能会添加类似以下内容的自定义变量：

`doormand_flags=""`

在他们的 **rc.conf.local** ，使用":="风格的默认变量赋值会不恰当地覆盖用户的意图。 `_enable` 变量是必须的而且必须使用":"来设置默认值。

> **重要**
> 
> 

## 6.26.1 提交前的清单

在贡献一个带有 **rc.d** 脚本的 port 前，更重要的是，在提交之前，确认以下的清单是否准备完毕。

[devel/rclint](https://cgit.freebsd.org/ports/tree/devel/rclint/) port程序可以检查其中大部分内容，但它并不是合格检查的替代品。

1. 如果这是一个新文件，它是否以 .sh 为文件扩展名？如果是，必须更改为 .in ，因为 rc.d 文件不能以那个文件扩展名结尾。

2. 
