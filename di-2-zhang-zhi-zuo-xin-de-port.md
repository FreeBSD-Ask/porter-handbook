# 第 2 章 制作新的 port

本节描述如何快速创建一个新的port。对于那些快速方法不足以满足需求的应用程序，可以参考完整的“慢迁移”过程，详细说明在慢迁移中。

首先，获取原始 tarball 并将其放入 DISTDIR ，默认为/usr/ports/distfiles。

|  | 这些步骤假定软件可以直接编译而成。换句话说，对于在 FreeBSD 系统上运行应用程序而言，绝对不需要进行任何更改。如果需要进行任何更改，请参考慢速移植。 |
| -- | --------------------------------------------------------------------------------------------------------------------------------------------------- |

```
# echo DEVELOPER=yes >> /etc/make.conf
```

此设置启用“开发人员模式”，显示弃用警告并在调用 make 时激活一些进一步的质量检查。

## 3.1. 写 Makefile

最小的 Makefile 看起来应该像这样:

```
PORTNAME=	oneko
DISTVERSION=	1.1b
CATEGORIES=	games
MASTER_SITES=	ftp://ftp.rediris.es/sites/ftp.freebsd.org/pub/FreeBSD/

MAINTAINER=	youremail@example.com
COMMENT=	Cat chasing a mouse all over the screen
WWW=		http://www.daidouji.com/oneko/

.include <bsd.port.mk>
```

试着弄清楚。更详细的示例在示例 Makefile 部分中显示。

## 3.2. 编写描述文件

无论 port 是否实际打包，都需要两个描述文件。它们是 pkg-descr 和 pkg-plist。它们的 pkg- 前缀使它们与其他文件区分开来。

### 3.2.1. pkg-descr

这是对port的更详细描述。简要解释port的一到几段即可。

|  | 这不是一本手册，也不是深入描述如何使用或编译port的说明！在从 README 或 manpage 复制时请小心。太多时候它们不是对port的简明描述，或者格式很尴尬。例如，manpage 具有两端对齐的间距，这在等宽字体下看起来特别糟糕。<br /><br />另一方面，pkg-descr 的内容必须比 Makefile 中 COMMENT 行更长。它必须更深入地解释port究竟是什么。 |
| -- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

一个写得很好的 pkg-descr 完全描述了port，让用户不必查阅文档或访问网站即可了解软件的功能，它如何有用，或者有哪些特别好的功能。 提及诸如图形工具包、大量依赖项、运行时环境或实现语言之类的特定要求可以帮助用户决定这个port是否适合他们。

|  | 曾经包含在 pkg-descr 文件最后一行的 URL 已移至 Makefile。 |
| -- | ----------------------------------------------------------- |

### 3.2.2. pkg-plist

此文件列出了由 port 安装的所有文件。它也被称为“打包列表”，因为包是通过打包这里列出的文件生成的。路径名是相对于安装前缀（通常为 /usr/local）的。

这里是一个小例子：

```
bin/oneko
man/man1/oneko.1.gz
lib/X11/app-defaults/Oneko
lib/X11/oneko/cat1.xpm
lib/X11/oneko/cat2.xpm
lib/X11/oneko/mouse.xpm
```

参考 pkg-create(8) 手册页面，获取有关打包列表的详细信息。

|  | 建议将此文件中的所有文件名按字母顺序排序。这样，在升级port时验证更改会更容易进行。排序应在变量扩展后应用。当自动生成软件包列表时，框架会正确执行此操作。 |
| -- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |

|  | 手动创建打包清单可能是一项非常繁琐的任务。如果port安装了大量文件，自动创建打包清单可能会节省时间。 |
| -- | ---------------------------------------------------------------------------------------------------- |

只有一种情况可以省略 pkg-plist 于port。如果port只安装了少量文件，请在port的 Makefile 中列出它们。例如，我们可以通过将以下行添加到 Makefile 中，在上述 oneko port中不使用 pkg-plist：

```
PLIST_FILES=	bin/oneko \
		man/man1/oneko.1.gz \
		lib/X11/app-defaults/Oneko \
		lib/X11/oneko/cat1.xpm \
		lib/X11/oneko/cat2.xpm \
		lib/X11/oneko/mouse.xpm
```

|  | 不应滥用 PLIST_FILES 。在查找文件来源时，人们通常会尝试通过ports树中的 pkg-plist 文件进行 grep 搜索。在 Makefile 中列出 PLIST_FILES 中的文件会使搜索更加困难。 |
| -- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |

|  | 如果port需要创建一个空目录，或在安装过程中在${PREFIX}之外创建目录，请参阅清理空目录以获取更多信息。 |
| -- | ----------------------------------------------------------------------------------------------------- |

```
PLIST_FILES=	"@sample ${ETCDIR}/oneko.conf.sample"
```

稍后我们将看到如何使用 pkg-plist 和 PLIST_FILES 来完成更复杂的任务。

## 3.3. 创建校验和文件

只需键入 make makesum 。ports 框架将自动生成 distinfo。请勿尝试手动生成文件。

## 3.4. 测试 Port

确保port规则确实如期望的那样，包括打包port。以下是需要验证的重要点：

* pkg-plist 不包含任何未被port安装的内容。
* pkg-plist 包含所有被port安装的内容。
* port 可以使用 install 目标进行安装。这将验证安装脚本是否正常工作。
* port 可以使用 deinstall 目标进行正确卸载。这将验证卸载脚本是否正常工作。
* 在 fetch 目标阶段期间，port 仅能访问网络资源。这对软件包构建者非常重要，例如 ports-mgmt/poudriere。
* 确保 make package 可以作为普通用户运行（即不作为 root ）。如果失败，可能需要对软件进行补丁。另请参阅 fakeroot 和 uidfix 。

过程：推荐的测试顺序

1. `make stage`
2. `make stage-qa`
3. `make package`
4. `make install`
5. `make deinstall`
6. make package （作为用户）

确保在任何阶段都不会显示警告。

可以使用ports-mgmt/poudriere 进行彻底的自动化测试，来自Ports Collection，请参阅 poudriere 了解更多信息。它维护了 jails ，所有上述步骤都可以在不影响主机系统状态的情况下进行测试。

## 3.5. 使用 portlint 检查Port

请使用 portlint 来查看port是否符合我们的指南。ports-mgmt/portlint 程序是ports集合的一部分。特别是，检查 Makefile 是否格式正确，并且软件包命名是否合适。

|  | 不要盲目跟随 portlint 的输出。它是一个静态 lint 工具，有时会出错。 |
| -- | -------------------------------------------------------------------- |

## 3.6. 提交新的Port

在提交新的port之前，请阅读《DOs and DON’Ts》部分。

一旦对port满意，唯一剩下的就是将其放入主要的 FreeBSDports树，并让其他人也对此感到满意。

|  | 我们不需要工作目录或 pkgname.txz 软件包，因此现在删除它们。 |
| -- | ------------------------------------------------------------- |

然后，创建一个 patch(1) 文件。假设 port 名为 oneko ，属于 games 类别。

示例 1. 为新的 Port 创建 .diff 文件

添加所有带有 git add . 的文件，然后使用 git diff 查看差异。例如：

```
% git add .
% git diff --staged
```

确保包含所有必需文件，然后将更改提交到本地分支，并使用 git format-patch 生成补丁。

```
% git commit
% git format-patch origin/main
```

使用 git format-patch 生成的补丁将包含作者身份和电子邮件地址，这将使开发人员更容易应用（使用 git am ）并给予适当的荣誉。

为使提交者更容易将补丁应用到其ports树的工作副本上，请从您的ports树的基础生成 .diff。

使用 bug 提交表单提交 oneko.diff。使用产品"Ports & 软件包"，组件"单个Port(s)"，并按照那里显示的指南操作。在 PR 的描述字段中添加程序的简短描述（也许是 COMMENT 的简短版本），并记得将 oneko.diff 作为附件添加。

|  | 在问题报告摘要中提供良好的描述可以极大地简化port提交者和审查者的工作。新ports的预期格式为"[NEW PORT] 类别/端口名 port 的简短描述"。使用此方案可以更轻松快速地开始提交新的port。 |
| -- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

提交port后，请耐心等待。将新port包含在 FreeBSD 中所需的时间从几天到几个月不等。可以在 https://bugs.freebsd.org/bugzilla/query.cgi 上搜索问题报告数据库的简单搜索表单。

要获取所有 port 个开放的 PR，请在搜索表单中选择“开放”和 Ports & 软件包，然后点击“搜索”。

在查看新的 port 后，如有必要我们会回复，并将其提交到树中。提交者的名称也将被添加到附加的 FreeBSD 贡献者列表和其他文件中。

|  | 以前可以使用 shar(1) 文件提交新 ports 的补丁；随着 git(1) 的发展，这种方式不再可行。提交者不再接受 shar(1) 文件，因为这种方法容易出错，并且不会在类别的 Makefile 中添加相关条目。 |
| -- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
