# 3.1. 编写 Makefile

本节说明了如何快速创建一个新的 Port。对于那些快速方法不够充分的应用程序，完整的“慢速移植”过程在 [慢速移植](https://docs.freebsd.org/en/books/porters-handbook/slow-porting/#slow-porting) 中有详细说明。

首先，获取原始的 tarball 文件并将其放入 `DISTDIR`，默认路径为 **/usr/ports/distfiles**。

>**注意**
>
>这些步骤假设软件可以开箱即用编译运行。换句话说，应用程序在 FreeBSD 系统上工作时完全不需要修改。如果需要修改，请参考 [慢速移植](https://docs.freebsd.org/en/books/porters-handbook/slow-porting/#slow-porting)。

>**注意**
>
>建议在进行移植之前，在 `/etc/make.conf` 中设置 make(1) 变量 `DEVELOPER` 。
>
>```sh
># echo DEVELOPER=yes >> /etc/make.conf
>```
>
>此设置启用“开发者模式”，该模式会显示弃用警告，并在调用 make 时激活一些额外的质量检查。

---

**Makefile** 的最简版本看起来如下所示：

```sh
PORTNAME=	oneko
DISTVERSION=	1.1b
CATEGORIES=	games
MASTER_SITES=	ftp://ftp.rediris.es/sites/ftp.freebsd.org/pub/FreeBSD/

MAINTAINER=	youremail@example.com
COMMENT=	Cat chasing a mouse all over the screen
WWW=		http://www.daidouji.com/oneko/

.include <bsd.port.mk>
```

尝试理解它。更详细的示例请参见 [示例 Makefile](https://docs.freebsd.org/en/books/porters-handbook/porting-samplem/#porting-samplem) 部分。

## 3.2. 编写描述文件

每个 Ports 都需要两个描述文件，无论它是否打包。这两个文件是 **pkg-descr** 和 **pkg-plist**。它们的 **pkg-** 前缀将它们与其他文件区分开来。

### 3.2.1. **pkg-descr**

这是对 Ports 的更详细描述。简洁地解释 Ports 做什么，通常只需要一到几段。

>**注意**
>
>这不是 *手册* 或 *关于如何使用或编译 Ports 的详细描述*！ *请小心不要直接从 **README** 或 manpage 中复制*. 它们往往不是对 Ports 的简明描述，或者格式不合适。例如，man 页面的文本有对齐间距，用等宽字体显示时会显得很不美观。
>
>另一方面，**pkg-descr** 文件的内容必须比 Makefile 中的 [`COMMENT`](https://docs.freebsd.org/en/books/porters-handbook/makefiles/#makefile-comment) 行更长。它必须更深入地解释 Ports 的作用。 

一份写得好的 **pkg-descr** 文件应该足够详细，让用户理解这个 Ports 是做什么的，如何使用或为何有用，或者它的哪些特别之处。提到一些要求，比如图形工具包、重依赖、运行时环境或实现语言等，会帮助用户判断这个 Ports 是否适合他们。

>**注意**
>
>以前通常在 **pkg-descr** 文件的最后一行包含的 URL，现在已移至 **Makefile** 中。 

### 3.2.2. **pkg-plist**

此文件列出了 Ports 安装的所有文件。它也叫做“打包列表”，因为生成的包就是通过打包此处列出的文件来创建的。文件路径是相对于安装前缀（通常是 **/usr/local**）的。

这是一个小示例：

```sh
bin/oneko
man/man1/oneko.1.gz
lib/X11/app-defaults/Oneko
lib/X11/oneko/cat1.xpm
lib/X11/oneko/cat2.xpm
lib/X11/oneko/mouse.xpm
```

有关打包列表的详细信息，请参阅 [pkg-create(8)](https://man.freebsd.org/cgi/man.cgi?query=pkg-create&sektion=8&format=html) 手册页。

>**注意**
>
>建议将该文件中的所有文件名按字母顺序排列。这样在升级 Ports 时验证变更会更容易。排序应在变量展开后进行。框架在自动生成包列表时会正确处理此操作。 

>**技巧**
>
>手动创建打包列表可能是一项非常繁琐的任务。如果 Ports 安装了大量文件，[自动生成打包列表](https://docs.freebsd.org/en/books/porters-handbook/plist/#plist-autoplist) 可能会节省时间。

只有在 Ports 安装的文件非常少的情况下，**pkg-plist** 可以省略。如果 Ports 只安装少数文件，可以在 Makefile 的 `PLIST_FILES` 中列出它们。例如，在上述 **oneko** Ports 中，我们可以通过将以下行添加到 **Makefile** 来省略 **pkg-plist**：

```sh
PLIST_FILES=	bin/oneko \
		man/man1/oneko.1.gz \
		lib/X11/app-defaults/Oneko \
		lib/X11/oneko/cat1.xpm \
		lib/X11/oneko/cat2.xpm \
		lib/X11/oneko/mouse.xpm
```

>**注意**
>
> 不应滥用 `PLIST_FILES`。在查找文件来源时，人们通常会在 Ports 树中的 **pkg-plist** 文件中查找。将文件列在 **Makefile** 中的 `PLIST_FILES` 会使这个搜索变得更加困难。

>**技巧**
>
> 如果 Port 需要创建空目录，或在安装过程中创建了 **\${PREFIX}** 以外的目录，请参阅 [清理空目录](https://docs.freebsd.org/en/books/porters-handbook/plist/#plist-dir-cleaning) 了解更多信息。

>**技巧**
>
>由于 `PLIST_FILES` 是一个 [make(1)](https://man.freebsd.org/cgi/man.cgi?query=make&sektion=1&format=html) 变量，任何包含空格的条目必须加引号。例如，如果使用 [pkg-create(8)](https://man.freebsd.org/cgi/man.cgi?query=pkg-create&sektion=8&format=html) 和 [使用关键字扩展包列表](https://docs.freebsd.org/en/books/porters-handbook/plist/#plist-keywords) 中描述的关键字，条目必须加引号。
>
>```sh
>PLIST_FILES=	"@sample ${ETCDIR}/oneko.conf.sample"
>``` 

稍后我们将看到 **pkg-plist** 和 `PLIST_FILES` 如何用于完成 [更复杂的任务](https://docs.freebsd.org/en/books/porters-handbook/plist/#plist)。

## 3.3. 创建校验和文件

只需输入 `make makesum`。Ports 框架会自动生成 **distinfo** 文件。不要尝试手动生成该文件。

## 3.4. 测试 Port

确保 Port 的规则完全符合预期，包括打包 Port。以下是需要验证的重要点：

* **pkg-plist** 不包含 Port 未安装的任何内容。
* **pkg-plist** 包含 Port 安装的所有文件。
* 可以使用 `install` 目标安装 Port。这验证了安装脚本是否正常工作。
* 可以使用 `deinstall` 目标正确卸载 Port。这验证了卸载脚本是否正常工作。
* 仅在 `fetch` 目标阶段，Port 才能访问网络资源。这对包构建器（如 [ports-mgmt/poudriere](https://cgit.freebsd.org/ports/tree/ports-mgmt/poudriere/)) 非常重要。
* 确保 `make package` 可以作为普通用户（即非 `root` 用户）运行。如果失败，可能需要修补软件。参见 [fakeroot](https://docs.freebsd.org/en/books/porters-handbook/uses/#uses-fakeroot) 和 [uidfix](https://docs.freebsd.org/en/books/porters-handbook/uses/#uses-uidfix)。

推荐的测试顺序：

1. `make stage`
2. `make stage-qa`
3. `make package`
4. `make install`
5. `make deinstall`
6. `make package`（作为普通用户）

确保在任何阶段都没有出现警告。

可以使用 [ports-mgmt/poudriere](https://cgit.freebsd.org/ports/tree/ports-mgmt/poudriere/) 进行彻底的自动化测试，具体信息请参阅 [poudriere](https://docs.freebsd.org/en/books/porters-handbook/testing/#testing-poudriere)。它维护了 `jails`，可以在不影响主机系统状态的情况下测试上述所有步骤。

## 3.5. 使用 `portlint` 检查 Port

请使用 `portlint` 检查 Port 是否符合我们的规范。[ports-mgmt/portlint](https://cgit.freebsd.org/ports/tree/ports-mgmt/portlint/) 程序是 Ports 集合的一部分。特别是，检查 [Makefile](https://docs.freebsd.org/en/books/porters-handbook/porting-samplem/#porting-samplem) 是否格式正确，以及 [package](https://docs.freebsd.org/en/books/porters-handbook/porting-pkgname/#porting-pkgname) 是否命名得当。

>**重要**
>
>不要盲目遵循 `portlint` 的输出。它是一个静态 lint 工具，有时会出错。

## 3.6. 提交新 Port

在提交新 Port 之前，请阅读 [DOs 和 DON’Ts](https://docs.freebsd.org/en/books/porters-handbook/porting-dads/#porting-dads) 部分。

确认 Port 一切正常后，唯一剩下的就是将它提交到主 FreeBSD Ports 树中，让其他人也高兴。

>**重要**
>
>我们不需要 **work** 目录或 **pkgname.txz** 包，因此现在删除它们。

接下来，创建一个 [patch(1)](https://man.freebsd.org/cgi/man.cgi?query=patch&sektion=1&format=html) 文件。假设该 Port 名为 `oneko`，位于 `games` 类别中。

**示例 1. 为新 Port 创建 `.diff`**

使用 `git add .` 添加所有文件，然后通过 `git diff` 查看差异。例如：

```sh
% git add .
% git diff --staged
```

确保所有必需的文件都已包含，然后将更改提交到本地分支，并使用 `git format-patch` 生成补丁：

```sh
% git commit
% git format-patch origin/main
```

通过 `git format-patch` 生成的补丁将包含作者身份和电子邮件地址，便于开发者应用补丁（使用 `git am`）并给予适当的信用。

为了便于提交者将补丁应用到他们的 Ports 树工作副本上，请从 Ports 树的根目录生成 **.diff** 文件。

通过 [bug 提交表单](https://bugs.freebsd.org/submit/) 提交 **oneko.diff**。选择产品 "Ports & Packages"，组件 "Individual Port(s)"，并按照表单中的指南操作。在 PR 的描述字段中添加程序的简短描述（可以是 `COMMENT` 的简短版本），并记得将 **oneko.diff** 作为附件添加。

>**注意**
>
>在问题报告摘要中提供良好的描述能大大简化 Port 提交者和审核人员的工作。新 Port 的预期格式为 "\[NEW PORT] *category/portname short description of the port*"。使用这种格式可以更容易、更快速地开始提交新 Port 的工作。 

提交 Port 后，请耐心等待。将新 Port 纳入 FreeBSD 的时间可能从几天到几个月不等。可以通过 [https://bugs.freebsd.org/bugzilla/query.cgi](https://bugs.freebsd.org/bugzilla/query.cgi) 对问题报告数据库进行简单搜索。

要列出 *开放* 的 Port PR，选择 *Open* 和 *Ports & Packages*，然后点击 **Search**。

查看新 Port 后，我们将根据需要进行回复，并将其提交到树中。提交者的名字还将添加到 [Additional FreeBSD Contributors](https://docs.freebsd.org/en/articles/contributors/#contrib-additional) 和其他文件中。

>**重要**
>
>之前可以通过 [shar(1)](https://man.freebsd.org/cgi/man.cgi?query=shar&sektion=1&format=html) 文件提交新 Port 的补丁；但随着 [git(1)](https://man.freebsd.org/cgi/man.cgi?query=git&sektion=1&format=html) 的发展，这种方式不再被接受。提交者不再接受 [shar(1)](https://man.freebsd.org/cgi/man.cgi?query=shar&sektion=1&format=html) 文件，因为其使用容易出错，并且不会在类别的 **Makefile** 中添加相关条目。
